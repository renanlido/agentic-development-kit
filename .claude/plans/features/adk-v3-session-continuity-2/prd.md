# PRD: adk-v3-session-continuity-2

**Data:** 2026-01-26
**Status:** Draft
**Autor:** Auto-generated
**Sprint:** 2 (Dual-Agent Prompts)
**Dependência:** Sprint 1 (adk-v3-session-continuity) ✅ Completo

---

## 1. Problema

### 1.1 Contexto

O ADK v2 sofre de um problema crítico identificado no artigo [Anthropic Engineering - Effective harnesses for long-running agents](https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents):

- **One-shotting**: O agente tenta fazer tudo de uma vez, esgotando o contexto no meio da implementação
- **Declaração prematura de vitória**: O agente vê progresso parcial e declara o projeto completo

### 1.2 Problema Específico do Sprint 2

O Sprint 1 implementou com sucesso o **Session Store** e o **Claude v3 executor** com:
- Persistência de sessões em disco
- Captura de session IDs via `--print-session-id`
- Suporte a resume via `--resume`
- Tracking automático de sessões

**O que falta:**
- Não há diferenciação entre primeira sessão (setup) e sessões subsequentes (trabalho incremental)
- Todos os prompts são idênticos, não seguindo o padrão dual-agent da Anthropic
- Não existe geração automática de `feature_list.json` para testes estruturados
- Não existe geração de `init.sh` para setup do ambiente

### 1.3 Impacto Atual

| Comportamento | Esperado (Anthropic) | Atual (ADK) |
|---------------|---------------------|-------------|
| Primeira sessão | Setup: gera artefatos, configura ambiente | Mesmo prompt de sempre |
| Sessões subsequentes | Trabalho incremental, lê git log | Mesmo prompt de sempre |
| Testes estruturados | `feature_list.json` com pass/fail | Não existe |
| Setup automático | `init.sh` executável | Não existe |

---

## 2. Solução Proposta

### 2.1 Arquitetura Dual-Agent

Implementar o padrão dual-agent conforme documentado em `02-long-running-agents-gap.md`:

```
┌─────────────────────────────────────────────────────────────────┐
│                       DETECÇÃO DE SESSÃO                        │
│                                                                  │
│   isFirstSession() ─────────┬─────────────────────────────────  │
│                             │                                    │
│          SIM                │              NÃO                   │
│          ▼                  │              ▼                     │
│   ┌─────────────────┐       │      ┌─────────────────┐          │
│   │ INITIALIZER     │       │      │ CODING AGENT    │          │
│   │ AGENT           │       │      │                 │          │
│   │                 │       │      │ - Lê progress   │          │
│   │ - Gera artefatos│       │      │ - Lê feature_list│         │
│   │ - feature_list  │       │      │ - git log       │          │
│   │ - init.sh       │       │      │ - Trabalha 1    │          │
│   │ - progress.txt  │       │      │   feature       │          │
│   │ - git commit    │       │      │ - Testa e2e     │          │
│   └─────────────────┘       │      │ - Commit        │          │
│                             │      └─────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Componentes a Implementar

| Arquivo | Responsabilidade |
|---------|-----------------|
| `src/utils/prompts/initializer-agent.ts` | Gera prompt para primeira sessão |
| `src/utils/prompts/coding-agent.ts` | Gera prompt para sessões subsequentes |
| `src/utils/feature-list.ts` | Gera e manipula `feature_list.json` |
| `src/utils/init-script.ts` | Gera `init.sh` para setup do ambiente |

### 2.3 Formato de Artefatos

#### feature_list.json
```json
{
  "feature": "nome-da-feature",
  "version": "1.0.0",
  "created": "2026-01-26T12:00:00Z",
  "tests": [
    {
      "id": "test-001",
      "description": "Descrição do teste funcional",
      "category": "functional|ui|integration|e2e",
      "steps": [
        "Passo 1",
        "Passo 2"
      ],
      "passes": false,
      "lastTested": null,
      "evidence": null
    }
  ],
  "summary": {
    "total": 10,
    "passing": 0,
    "failing": 0,
    "pending": 10
  }
}
```

#### init.sh
```bash
#!/bin/bash
# Auto-generated by ADK v3 Initializer Agent
# Feature: nome-da-feature
# Created: 2026-01-26

set -e

# Environment setup
echo "Starting development environment..."

# Project-specific commands
npm install 2>/dev/null || true
npm run dev &

echo "Environment ready!"
```

---

## 3. Requisitos Funcionais

### RF01: Detecção de Primeira Sessão
- Sistema DEVE detectar se é a primeira sessão de uma feature
- Critérios de primeira sessão:
  - `feature_list.json` não existe OU
  - `init.sh` não existe OU
  - `claude-progress.txt` está vazio/não existe
- Função: `isFirstSession(feature: string): Promise<boolean>`

### RF02: Prompt do Initializer Agent
- Sistema DEVE gerar prompt especializado para primeira sessão
- Prompt DEVE instruir Claude a:
  - Ler PRD da feature
  - Extrair TODOS os requisitos testáveis
  - Gerar `feature_list.json` com testes estruturados
  - Gerar `init.sh` executável
  - Criar `claude-progress.txt` inicial
  - Fazer git commit dos artefatos
- Função: `buildInitializerPrompt(feature: string, context?: PromptContext): string`

### RF03: Prompt do Coding Agent
- Sistema DEVE gerar prompt especializado para sessões subsequentes
- Prompt DEVE instruir Claude a:
  - Executar `pwd` para confirmar diretório
  - Ler `claude-progress.txt`
  - Ler `feature_list.json`
  - Executar `git log --oneline -20`
  - Executar `./init.sh`
  - Trabalhar em UMA feature por vez
  - Testar end-to-end antes de marcar como "passes: true"
  - Fazer git commit após cada feature
  - Atualizar `claude-progress.txt` antes de encerrar
- Função: `buildCodingAgentPrompt(feature: string, context?: PromptContext): string`

### RF04: Gerador de feature_list.json
- Sistema DEVE criar template inicial de `feature_list.json`
- Sistema DEVE permitir adicionar novos testes
- Sistema DEVE atualizar status de testes (passes: true/false)
- Sistema DEVE calcular summary automaticamente
- Sistema DEVE preservar IDs únicos de testes
- Classe: `FeatureList`
  - `create(feature: string, tests?: TestDefinition[]): Promise<void>`
  - `addTest(feature: string, test: TestDefinition): Promise<void>`
  - `updateTestStatus(feature: string, testId: string, passes: boolean, evidence?: string): Promise<void>`
  - `get(feature: string): Promise<FeatureListData | null>`
  - `getSummary(feature: string): Promise<FeatureListSummary>`

### RF05: Gerador de init.sh
- Sistema DEVE gerar script de setup executável
- Script DEVE ser customizável baseado no tipo de projeto
- Script DEVE detectar tipo de projeto (node, python, etc.)
- Script DEVE ser idempotente (pode rodar múltiplas vezes)
- Classe: `InitScript`
  - `create(feature: string, options?: InitScriptOptions): Promise<void>`
  - `detect(projectRoot: string): Promise<ProjectType>`
  - `get(feature: string): Promise<string | null>`

### RF06: Integração com Session Store
- Prompts DEVEM receber contexto da sessão atual
- Prompts DEVEM incluir histórico resumido se disponível
- Sistema DEVE persistir qual agente foi usado (initializer/coding)
- Metadata de sessão DEVE incluir campo `agentType: 'initializer' | 'coding'`

---

## 4. Requisitos Não-Funcionais

### RNF01: Performance
- Geração de prompt: < 50ms
- Leitura/escrita de feature_list.json: < 100ms
- Detecção de tipo de projeto: < 200ms

### RNF02: Compatibilidade
- DEVE funcionar com estrutura de features existente
- DEVE manter compatibilidade com SessionStore do Sprint 1
- NÃO DEVE modificar arquivos v2 (`src/cli.ts`, `src/commands/feature.ts`)
- DEVE usar apenas `npm run adk3` para testes

### RNF03: Robustez
- DEVE tratar arquivos corrompidos/malformados gracefully
- DEVE validar JSON antes de persistir
- DEVE usar padrão atomic write para feature_list.json

### RNF04: Testabilidade
- Cobertura de testes >= 80% para todos os novos arquivos
- Testes unitários para cada função pública
- Testes de integração para fluxo completo

### RNF05: Isolamento
- Testes DEVEM usar diretórios temporários
- Testes NÃO DEVEM afetar features reais
- Mock de ambiente DEVE ser possível via variáveis de ambiente

---

## 5. User Stories

### US01: Primeira Sessão de Feature
**Como** desenvolvedor usando ADK v3
**Quero** que a primeira sessão de uma feature configure automaticamente o ambiente
**Para** ter todos os artefatos necessários para trabalho incremental

**Critérios de Aceitação:**
- [ ] Ao executar `adk3 feature work <name>` pela primeira vez, usa Initializer Agent
- [ ] `feature_list.json` é criado com testes extraídos do PRD
- [ ] `init.sh` é criado e executável
- [ ] `claude-progress.txt` é inicializado
- [ ] Git commit automático dos artefatos gerados

### US02: Sessões Subsequentes
**Como** desenvolvedor usando ADK v3
**Quero** que sessões subsequentes retomem o contexto anterior
**Para** ter continuidade no trabalho sem perder progresso

**Critérios de Aceitação:**
- [ ] Ao executar `adk3 feature work <name>` novamente, usa Coding Agent
- [ ] Claude lê automaticamente `feature_list.json`
- [ ] Claude lê automaticamente `claude-progress.txt`
- [ ] Claude executa `git log` para entender histórico
- [ ] Claude foca em UMA feature pendente do `feature_list.json`

### US03: Tracking de Testes
**Como** desenvolvedor usando ADK v3
**Quero** visualizar o progresso dos testes estruturados
**Para** saber quantas features estão completas

**Critérios de Aceitação:**
- [ ] `adk3 feature tests <name>` lista todos os testes
- [ ] Exibe status: passing (verde), failing (vermelho), pending (amarelo)
- [ ] Exibe summary: X/Y tests passing
- [ ] Indica próximo teste a ser trabalhado

### US04: Customização de init.sh
**Como** desenvolvedor usando ADK v3
**Quero** que o init.sh seja gerado baseado no meu tipo de projeto
**Para** ter comandos de setup apropriados automaticamente

**Critérios de Aceitação:**
- [ ] Detecta projeto Node.js e inclui `npm install`
- [ ] Detecta projeto Python e inclui `pip install`
- [ ] Detecta Docker e inclui `docker-compose up`
- [ ] Permite customização manual após geração

---

## 6. Escopo

### 6.1 Incluído
- Implementação de `src/utils/prompts/initializer-agent.ts`
- Implementação de `src/utils/prompts/coding-agent.ts`
- Implementação de `src/utils/feature-list.ts`
- Implementação de `src/utils/init-script.ts`
- Tipos TypeScript para todos os novos componentes
- Testes unitários com cobertura >= 80%
- Testes de integração para fluxo dual-agent
- Atualização de `feature-v3.ts` para usar prompts diferenciados

### 6.2 Excluído (Out of Scope)
- Modificação de `src/cli.ts` (v2)
- Modificação de `src/commands/feature.ts` (v2)
- Execução de `npm link`
- Implementação do comando `feature work` completo (Sprint 3)
- Browser automation para testes e2e (Sprint futuro)
- Migração para Python SDK (v4)
- Constitution/Steering layer

---

## 7. Riscos e Mitigações

| Risco | Impacto | Probabilidade | Mitigação |
|-------|---------|---------------|-----------|
| Prompts muito longos esgotam contexto | Alto | Média | Limitar tamanho do prompt, incluir apenas informações essenciais |
| Claude ignora instruções do prompt | Alto | Baixa | Testes extensivos, iteração no wording do prompt |
| Detecção de projeto falha | Médio | Média | Fallback para template genérico, log de warning |
| Conflito com artefatos v2 existentes | Médio | Baixa | Validação de estrutura antes de sobrescrever |
| feature_list.json fica desatualizado | Médio | Alta | Instruir Claude a sempre atualizar ao final da sessão |

---

## 8. Métricas de Sucesso

### 8.1 Métricas Técnicas
- Cobertura de testes >= 80% para todos os novos arquivos
- Tempo de geração de prompt < 50ms
- Todos os testes passando (`npm test`)
- Zero modificações em arquivos v2

### 8.2 Métricas de Qualidade
- Initializer Agent gera artefatos válidos em 95%+ dos casos
- `feature_list.json` gerado é JSON válido em 100% dos casos
- `init.sh` gerado é executável em 100% dos casos

### 8.3 Métricas de Uso (futuro)
- Redução de sessões necessárias por feature: de 7+ para 3-5
- Aumento de contexto mantido entre sessões: de ~0% para >80%
- Redução de declarações prematuras de vitória: de ~40% para <10%

---

## 9. Dependências

### 9.1 Dependências Técnicas (já implementadas no Sprint 1)
- ✅ `src/utils/session-store.ts` - Persistência de sessões
- ✅ `src/utils/claude-v3.ts` - Executor com session tracking
- ✅ `src/types/session-v3.ts` - Tipos de sessão
- ✅ `src/cli-v3.ts` - Entry point v3
- ✅ `src/commands/feature-v3.ts` - Comandos básicos v3

### 9.2 Dependências de Runtime
- Node.js >= 18.0.0
- fs-extra (já instalado)
- Claude CLI instalado e configurado

### 9.3 Dependências de Contexto
- PRD da feature DEVE existir em `.claude/plans/features/{name}/prd.md`
- Diretório da feature DEVE existir

---

## 10. Timeline (Sugestão)

### Sprint 2: Dual-Agent Prompts (3 dias)

**Dia 1: Infraestrutura**
- Task 1-3: Tipos e interfaces
- Task 4-6: Testes e implementação de `feature-list.ts`

**Dia 2: Geradores**
- Task 7-9: Testes e implementação de `init-script.ts`
- Task 10-11: Detecção de tipo de projeto

**Dia 3: Prompts**
- Task 12-14: Testes e implementação de `initializer-agent.ts`
- Task 15-17: Testes e implementação de `coding-agent.ts`
- Task 18-19: Integração e validação

---

## 11. Interfaces e Tipos

### 11.1 Tipos para feature_list.json

```typescript
interface TestDefinition {
  id: string
  description: string
  category: 'functional' | 'ui' | 'integration' | 'e2e'
  steps: string[]
  passes: boolean
  lastTested: string | null
  evidence: string | null
}

interface FeatureListData {
  feature: string
  version: string
  created: string
  tests: TestDefinition[]
  summary: FeatureListSummary
}

interface FeatureListSummary {
  total: number
  passing: number
  failing: number
  pending: number
}
```

### 11.2 Tipos para init.sh

```typescript
type ProjectType = 'node' | 'python' | 'rust' | 'go' | 'docker' | 'unknown'

interface InitScriptOptions {
  projectType?: ProjectType
  customCommands?: string[]
  skipDetection?: boolean
}
```

### 11.3 Tipos para Prompts

```typescript
interface PromptContext {
  feature: string
  prdContent?: string
  progressContent?: string
  featureListContent?: FeatureListData
  gitLogOutput?: string
  sessionInfo?: SessionInfoV3
}

type AgentType = 'initializer' | 'coding'
```

---

## 12. Critérios de Aceite do Sprint

### 12.1 Obrigatórios (P0)
- [ ] `isFirstSession()` detecta corretamente primeira sessão
- [ ] `buildInitializerPrompt()` gera prompt válido
- [ ] `buildCodingAgentPrompt()` gera prompt válido
- [ ] `FeatureList.create()` gera JSON válido
- [ ] `FeatureList.updateTestStatus()` atualiza corretamente
- [ ] `InitScript.create()` gera bash executável
- [ ] `InitScript.detect()` identifica tipo de projeto
- [ ] Cobertura de testes >= 80%
- [ ] `npm test` passa sem erros
- [ ] `git diff src/cli.ts` retorna vazio
- [ ] `git diff src/commands/feature.ts` retorna vazio

### 12.2 Desejáveis (P1)
- [ ] Prompts otimizados para tamanho (< 2000 tokens cada)
- [ ] Suporte a múltiplos tipos de projeto no init.sh
- [ ] Validação de JSON schema para feature_list.json
- [ ] Logs detalhados de debug

---

*PRD gerado automaticamente - ADK v3 Sprint 2*
