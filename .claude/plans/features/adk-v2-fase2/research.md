# Research: adk-v2-fase2

**Feature:** Session Management for Long-Running Agents
**Date:** 2026-01-21
**Status:** Research Complete

---

## Current State Analysis

### Existing Infrastructure

ADK Fase 0 already provides foundational components for session management:

1. **Session Checkpoint System** (partial implementation)
   - `src/utils/session-checkpoint.ts` - Creates snapshots with `session_end` reason
   - `src/types/hooks.ts` - Defines `SessionCheckpointResult` interface
   - `.claude/hooks/session-checkpoint.sh` - Stop hook creating checkpoints
   - Tests: `tests/utils/session-checkpoint.test.ts` (10 tests)

2. **State Management**
   - `StateManager` (`src/utils/state-manager.ts:20-248`) - Unified state loading/saving
   - `HistoryTracker` (`src/utils/history-tracker.ts:16-119`) - Phase transition audit
   - `SnapshotManager` (`src/utils/snapshot-manager.ts:13-135`) - State snapshots
   - `SyncEngine` (`src/utils/sync-engine.ts:38-130`) - Bidirectional sync

3. **Progress Tracking**
   - `progress.ts` (`src/utils/progress.ts:1-328`) - Feature progress management
   - `claude-progress.txt` - Plain-text handoff document (generated by hooks)
   - `progress.md` - Markdown progress file

4. **CLI Structure**
   - `src/commands/agent.ts` - Agent management (run, create, pipeline, parallel, status)
   - `src/commands/feature.ts` - Feature lifecycle (implement, restore, history, status)
   - Commander.js pattern for subcommands and options

### Current Flow

```
Session Start:
  session-bootstrap.sh → Injects active-focus.md + constraints

During Session:
  sync-state.sh → Updates progress.md + state.json on file changes
  validate-tdd.sh → TDD warnings on src/ file creation

Session End:
  session-checkpoint.sh → Creates snapshot + claude-progress.txt
```

**Gap:** No mechanism to RESUME from these checkpoints. The checkpoint exists but there's no `--resume` flag or `listSessions()` functionality.

---

## Similar Components

### 1. StateManager (`src/utils/state-manager.ts`)

**Relevant methods:**
- `loadUnifiedState(feature)` - Loads state from progress.md + tasks.md + state.json
- `saveUnifiedState(feature, state)` - Atomic save with temp file
- `calculateProgress(tasks)` - Calculates completion percentage
- `getStatePath(feature)` - Returns path to state.json

**Pattern to follow:** Extend this class rather than create new SessionManager (~800 LOC avoided)

### 2. SnapshotManager (`src/utils/snapshot-manager.ts`)

**Relevant methods:**
- `createSnapshot(feature, trigger)` - Creates snapshot in `.snapshots/`
- `listSnapshots(feature)` - Returns list of SnapshotMeta
- `restoreSnapshot(feature, snapshotId)` - Restores from snapshot
- `cleanupOldSnapshots(feature, keepCount)` - Auto-prunes old snapshots

**Reuse for:** Session snapshots - already handles file copying, metadata, cleanup

### 3. HistoryTracker (`src/utils/history-tracker.ts`)

**Relevant methods:**
- `recordTransition(feature, entry)` - Thread-safe transition recording
- `getHistory(feature, limit?)` - Retrieves transition history
- `pruneHistory(feature, keepCount)` - Prunes old entries

**Reuse for:** Session transition history

### 4. createSessionCheckpoint (`src/utils/session-checkpoint.ts`)

**Existing implementation:**
- Creates snapshot in `.snapshots/` with `session_end` reason
- Generates `claude-progress.txt` plain-text
- Returns `SessionCheckpointResult`

**Extend with:**
- More detailed handoff document format (DONE/IN PROGRESS/NEXT sections)
- Context summary generation
- Last activity tracking

### 5. Feature Command Pattern (`src/commands/feature.ts`)

**askToResume pattern** (lines 378-401):
```typescript
private async askToResume(name: string, state: FeatureState): Promise<boolean> {
  // Interactive prompt using inquirer
  // Checks if content exists, shows status
  // Returns boolean for continue/restart
}
```

**Reuse for:** `--resume` detection and prompt

---

## Technical Stack

| Component | Technology | Notes |
|-----------|------------|-------|
| CLI | Commander.js v14 | Subcommands, options, flags |
| Interactive prompts | Inquirer v13 | Choice menus, confirmations |
| File operations | fs-extra v11 | Atomic writes, ensure dirs |
| Spinners | ora v9 | Loading indicators |
| Colors | chalk v5 | Terminal formatting |
| Types | TypeScript ES2020 | Strict mode enabled |
| Testing | Jest + ts-jest | 80%+ coverage requirement |
| Linting | Biome v2.3 | Replaces ESLint + Prettier |

---

## Files to Create

### Core Types
- [ ] `src/types/session.ts` - LongRunningSession, CheckpointRef, SessionListItem types

### Template
- [ ] `templates/claude-progress.txt` - Handoff document template (plain-text)

### Hook
- [ ] `.claude/hooks/task-complete.sh` - Checkpoint per task completion

### Tests
- [ ] `tests/utils/session-management.test.ts` - Unit tests for new StateManager methods
- [ ] `tests/commands/agent-sessions.test.ts` - CLI integration tests

---

## Files to Modify

### High Impact (Core Changes)

| File | Change | Lines Affected |
|------|--------|----------------|
| `src/utils/state-manager.ts` | Add session methods | +150-200 |
| `src/commands/agent.ts` | Add --resume, sessions subcommand | +100-150 |
| `src/commands/feature.ts` | Add --resume to implement | +50-80 |
| `src/cli.ts` | Register agent sessions command | +10-15 |

### Medium Impact (Extensions)

| File | Change | Lines Affected |
|------|--------|----------------|
| `src/utils/session-checkpoint.ts` | Extend handoff document format | +30-50 |
| `src/types/hooks.ts` | Add session-related types | +20-30 |
| `.claude/settings.json` | Register task-complete hook | +5 |

### Low Impact (Updates)

| File | Change | Lines Affected |
|------|--------|----------------|
| `templates/claude-structure/hooks/` | Copy task-complete.sh | new file |
| `CLAUDE.md` | Document session management | +50-100 |

---

## Dependencies

### External (npm packages)
- No new dependencies required
- All functionality achievable with existing: fs-extra, chalk, ora, inquirer, commander

### Internal (module dependencies)

```
src/commands/agent.ts
  └── src/utils/state-manager.ts (NEW: session methods)
        ├── src/utils/snapshot-manager.ts (existing)
        ├── src/utils/history-tracker.ts (existing)
        └── src/types/session.ts (NEW)

src/commands/feature.ts
  └── src/utils/state-manager.ts (NEW: resumeFromSnapshot)
```

---

## Risks

### R1: StateManager Method Conflicts
**Description:** Adding session methods may conflict with existing progress-sync functionality
**Probability:** Medium | **Impact:** High
**Mitigation:**
- Use composition over inheritance
- Delegate to SnapshotManager/HistoryTracker
- Comprehensive integration tests

### R2: claude-progress.txt Corruption
**Description:** Manual edits or malformed content could break resume
**Probability:** Medium | **Impact:** Medium
**Mitigation:**
- Tolerant parser with fallback to state.json
- Validation before loading
- Auto-regenerate if corrupted

### R3: Stop Hook Not Executing (kill -9)
**Description:** Forceful termination bypasses Stop hook
**Probability:** Low | **Impact:** High
**Mitigation:**
- Periodic checkpoint during long operations
- Recovery from last known state.json
- Detect incomplete session on next start

### R4: Session Storage Growth
**Description:** Many sessions could bloat feature directory
**Probability:** Low | **Impact:** Medium
**Mitigation:**
- Default limit of 10 sessions (configurable)
- Auto-prune via SnapshotManager.cleanupOldSnapshots()
- Lazy loading of session details

### R5: Backward Compatibility
**Description:** Features created before v2 lack session infrastructure
**Probability:** Medium | **Impact:** Medium
**Mitigation:**
- StateManager already handles missing files gracefully
- Create default state on first access
- Migration on first session start

### R6: Race Condition in Concurrent Sessions
**Description:** Multiple Claude Code sessions editing same feature
**Probability:** Low | **Impact:** High
**Mitigation:**
- HistoryTracker already has mutex (withLock pattern)
- Apply same pattern to session operations
- File locking for atomic writes (already using temp + rename)

---

## Patterns to Follow

### 1. Atomic File Writes (from StateManager)
```typescript
const tempPath = path.join(os.tmpdir(), `state-${Date.now()}.json`)
await fs.writeJSON(tempPath, updatedState, { spaces: 2 })
await fs.move(tempPath, statePath, { overwrite: true })
```

### 2. Thread-Safe Operations (from HistoryTracker)
```typescript
private async withLock<T>(feature: string, fn: () => Promise<T>): Promise<T> {
  const existingLock = this.locks.get(feature)
  // ... acquire lock, execute fn, release
}
```

### 3. Error Handling (from all commands)
```typescript
const spinner = ora('Loading...').start()
try {
  // operation
  spinner.succeed('Success message')
} catch (error) {
  spinner.fail('Error message')
  logger.error(error instanceof Error ? error.message : String(error))
  process.exit(1)
}
```

### 4. CLI Flag Pattern (from feature.ts)
```typescript
.option('--resume', 'Resume from last session')
.action((name, options) => command.method(name, options))
```

### 5. Test Pattern (from state-manager.test.ts)
```typescript
beforeEach(async () => {
  tempDir = await fs.mkdtemp(path.join(os.tmpdir(), 'test-'))
  process.env.TEST_FEATURE_PATH = tempDir
})

afterEach(async () => {
  await fs.remove(tempDir)
  delete process.env.TEST_FEATURE_PATH
})
```

### 6. Graceful Degradation (from StateManager)
```typescript
if (await fs.pathExists(statePath)) {
  try {
    const loaded = await fs.readJSON(statePath)
    if (this.isValidState(loaded)) {
      state = loaded
    }
  } catch {}  // Silent fallback to default
}
```

---

## Performance Considerations

### Target Metrics (from PRD)

| Operation | Target | Current Baseline |
|-----------|--------|------------------|
| Checkpoint creation | < 200ms | ~150ms (SnapshotManager) |
| Session resume | < 500ms | N/A (not implemented) |
| Session listing | < 100ms | ~50ms (listSnapshots) |
| Handoff generation | < 300ms | ~50ms (basic version) |

### Optimization Strategies

1. **Lazy Loading:** Only load full session details when specifically requested
2. **Caching:** State already cached in state.json, reuse for session display
3. **Streaming:** For large session lists, stream rather than load all into memory
4. **Minimal I/O:** Reuse existing file reads rather than re-reading

---

## Security Considerations

### Data Exposure

1. **claude-progress.txt** - Plain text, readable by anyone
   - Mitigation: No secrets in handoff document
   - Only task names, file paths, progress percentages

2. **Session snapshots** - JSON files in `.snapshots/`
   - Mitigation: Add to `.gitignore` if containing sensitive state
   - Review snapshot content for PII

3. **state.json** - Contains task history
   - Already handled by existing security patterns

### Command Injection

1. **Hook scripts** - Execute shell commands
   - Already sanitized in existing hooks
   - Use `$VAR` variables, not user input
   - Validate paths before use

---

## Implementation Notes

### StateManager Extension Approach

```typescript
// Add to StateManager class:
async resumeFromSnapshot(feature: string, snapshotId?: string): Promise<UnifiedFeatureState>
async createContextSummary(feature: string): Promise<string>
async createHandoffDocument(feature: string): Promise<string>
async listSessions(feature: string): Promise<SessionListItem[]>
async getLatestSession(feature: string): Promise<LongRunningSession | null>
```

### claude-progress.txt Format

```
CURRENT: Implementing [task description] ([progress]% complete)

DONE:
- Task 1 description
- Task 2 description

IN PROGRESS:
- Current task being worked on

NEXT:
1. Immediate next task
2. Following task
3. Subsequent task

FILES: comma-separated list of modified files

ISSUES: None blocking | Issue description
```

### Session Storage Structure

```
.claude/plans/features/<feature>/
├── sessions/
│   ├── session-20260122-103000.json
│   └── session-20260122-143000.json
├── claude-progress.txt
├── state.json
└── .snapshots/
```

### CLI Output Format

```
adk agent sessions my-feature

Sessions for feature: my-feature

ID                          Started              Duration    Status       Progress
──────────────────────────────────────────────────────────────────────────────────
session-20260122-143000     2026-01-22 14:30     2h 15m      interrupted  5/8 (62%)
session-20260122-103000     2026-01-22 10:30     1h 45m      completed    8/8 (100%)

Use: adk agent run <name> --resume to continue the latest session
```

---

## Testing Strategy

### Unit Tests (tests/utils/session-management.test.ts)

1. `resumeFromSnapshot()` - Various snapshot states, missing files
2. `createContextSummary()` - Different progress states
3. `createHandoffDocument()` - Plain-text format validation
4. `listSessions()` - Empty, single, multiple sessions
5. `getLatestSession()` - No sessions, with sessions

### Integration Tests (tests/commands/agent-sessions.test.ts)

1. `adk agent sessions <feature>` - List format, empty list
2. `adk agent run <name> --resume` - Resume flow, no session
3. `adk feature implement <name> --resume` - Integration with feature command

### E2E Scenarios

1. Full session lifecycle: start → checkpoint → resume → complete
2. Interrupted session recovery
3. Multiple sessions for same feature
4. Backward compatibility with pre-v2 features

---

## Out of Scope (for Fase 2)

1. **Token counting via Anthropic API** - Fase 3
2. **Context compaction** - Fase 3
3. **Constitution/Steering** - Fase 4
4. **Git commits as checkpoints (full)** - Fase 5
5. **Circuit breaker/retry** - Fase 6
6. **Observability (Arize Phoenix)** - Fase 6

---

## Summary

Fase 2 builds on existing infrastructure with minimal new code:

1. **Extend StateManager** (+150-200 lines) with session methods
2. **Add CLI flags** (`--resume`) and command (`agent sessions`)
3. **Create task-complete hook** for granular checkpoints
4. **Generate plain-text handoff** documents per Anthropic recommendation
5. **Reuse existing** SnapshotManager, HistoryTracker for persistence

Total new/modified code estimate: **~500-600 lines** (vs ~1200+ if creating from scratch)

Key insight: The PRD's recommendation to extend StateManager rather than create SessionManager aligns with codebase patterns and avoids significant duplication.
